--- portage-utils/configure.ac	2011/12/19 20:27:36	1.5
+++ portage-utils/configure.ac	2012/01/16 01:10:32	1.6
@@ -13,6 +13,10 @@
 gl_EARLY
 gl_INIT
 
+AC_CHECK_FUNCS_ONCE(m4_flatten([
+	scandirat
+]))
+
 AC_ARG_WITH([eprefix], [AS_HELP_STRING([--with-eprefix], [path for Gentoo/Prefix project])])
 # ensure eprefix ends with a slash, since the code base expects that
 case "$with_eprefix" in
--- portage-utils/libq/scandirat.c	2011/12/22 18:29:23	1.3
+++ portage-utils/libq/scandirat.c	2012/01/16 01:10:32	1.4
@@ -1,12 +1,20 @@
 /*
  * Copyright 2005-2011 Gentoo Foundation
  * Distributed under the terms of the GNU General Public License v2
- * $Header: /var/cvsroot/gentoo-projects/portage-utils/libq/scandirat.c,v 1.3 2011/12/22 18:29:23 vapier Exp $
+ * $Header: /var/cvsroot/gentoo-projects/portage-utils/libq/scandirat.c,v 1.4 2012/01/16 01:10:32 vapier Exp $
  *
  * Copyright 2005-2010 Ned Ludd        - <solar@gentoo.org>
  * Copyright 2005-2011 Mike Frysinger  - <vapier@gentoo.org>
  */
 
+#if !defined(HAVE_SCANDIRAT)
+# if defined(__GLIBC__) && (__GLIBC__ << 8 | __GLIBC_MINOR__) > (2 << 8 | 14)
+#  define HAVE_SCANDIRAT
+# endif
+#endif
+
+#if !defined(HAVE_SCANDIRAT)
+
 static int scandirat(int dir_fd, const char *dir, struct dirent ***dirlist,
 	int (*filter)(const struct dirent *),
 	int (*compar)(const struct dirent **, const struct dirent **))
@@ -43,6 +51,8 @@
 	return cnt;
 }
 
+#endif
+
 _q_static void scandir_free(struct dirent **de, int cnt)
 {
 	if (cnt <= 0)
